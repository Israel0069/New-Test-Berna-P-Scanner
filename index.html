<script type="text/javascript">
    let totalPrice = 0;
    let isProcessing = false; // Variable to control scan delay
    let scannedProducts = []; // Array to store scanned products

    // Get the store_name from the URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const storeName = urlParams.get('store_name') || 'DefaultStoreName';

    function onScanSuccess(qrCodeMessage) {
        if (isProcessing) return;
        isProcessing = true;

        try {
            const qrData = JSON.parse(qrCodeMessage);
            const { product_name, price, store_name } = qrData;

            totalPrice += parseFloat(price);
            scannedProducts.push({ product_name, price, store_name });

            const productTable = document.querySelector('#product-table tbody');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `<td>${product_name}</td><td>${store_name}</td><td>₱${parseFloat(price).toFixed(2)}</td>`;
            productTable.appendChild(newRow);

            document.getElementById('total-price').innerText = `₱${totalPrice.toFixed(2)}`;
            document.getElementById('total-price-input').value = `Total Price: ₱${totalPrice.toFixed(2)}`;

            speak(`Scanned product: ${product_name}, Price: ₱${price}, Store: ${store_name}`);
        } catch (error) {
            document.getElementById('result').innerHTML = `<span class="result">Invalid QR Code Data</span>`;
        }

        setTimeout(() => {
            isProcessing = false;
        }, 3500);
    }

    function onScanError(errorMessage) {
        console.warn(errorMessage);
    }

    // Automatically open the back camera when the page loads
    function startQrScanner() {
        const html5QrcodeScanner = new Html5Qrcode("my-qr-reader");

        // Use the back camera by specifying the `facingMode`
        html5QrcodeScanner.start(
            { facingMode: "environment" }, // Automatically use the back camera
            {
                fps: 10,
                qrbox: 250,
            },
            onScanSuccess,
            onScanError
        ).catch((err) => {
            console.error("Camera error:", err);
        });
    }

    // Initialize the scanner on page load
    window.addEventListener('load', startQrScanner);

    function printReceipt() {
        const receiptTable = document.querySelector('#receipt-table tbody');
        receiptTable.innerHTML = '';
        scannedProducts.forEach(product => {
            const newRow = document.createElement('tr');
            newRow.innerHTML = `<td>${product.product_name}</td><td>${product.store_name}</td><td>₱${parseFloat(product.price).toFixed(2)}</td>`;
            receiptTable.appendChild(newRow);
        });

        document.getElementById('receipt-total-price').innerText = totalPrice.toFixed(2);
        document.getElementById('receipt').style.display = 'block';
        window.print();
        document.getElementById('receipt').style.display = 'none';
    }

    function saveToSession() {
        if (scannedProducts.length === 0) {
            alert('No products to save.');
            return;
        }

        const productData = scannedProducts.map((product, index) => {
            return `product_name[${index}]=${encodeURIComponent(product.product_name)}&store_name[${index}]=${encodeURIComponent(product.store_name)}&price[${index}]=${encodeURIComponent(product.price)}`;
        }).join('&');

        window.location.href = `http://192.168.1.100:8000/teller_Addcart?${productData}`;
    }

    function speak(text) {
        const speech = new SpeechSynthesisUtterance(text);
        window.speechSynthesis.speak(speech);
    }
</script>
